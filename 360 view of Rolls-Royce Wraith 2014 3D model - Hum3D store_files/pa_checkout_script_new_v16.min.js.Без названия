var my3DSContainer,require_modules,form3D=document.querySelector("#frmBrainTree"),btModal=document.getElementById("modal"),bankFrame=document.querySelector(".bt-modal-body"),closeFrame=document.getElementById("text-close"),amountInput=document.getElementById("amount"),emailInput=document.querySelector("#braintree_form_summary input[name=email]"),payBtn=document.getElementById("paysubmit"),payBtnSaved=document.getElementById("paysubmit_saved"),editPaymentMethodBtn=document.getElementById("edit_cart_btn"),editMode=!1,deleteToken="",frmBrainTree=document.getElementById("frmBrainTree"),gbutton=document.querySelector("#pay-with-google-button"),appleButton=document.querySelector("#pay-with-apple-button"),payBtnGroup=document.querySelector(".pay_g_a"),allowGooglePay=!1,allowApplePay=!1,autorizeOnly=document.querySelector("#authorize_only"),is_subscription=null!=document.querySelector("#plan_id"),xhr=new XMLHttpRequest,components={client:null,threeDSecure:null,hostedFields:null},merchantID=null;function CopyPayMethod(){jQuery("#frmCheckoutSend input[name=eshop_payment]").val(jQuery("input[name=eshop_payment_alt]:checked").val()),"braintree"==jQuery("#frmCheckoutSend input[name=eshop_payment]").val()&&jQuery("#frmCheckoutSend").attr("action",jQuery("#frmCheckoutSend").attr("action").split("?")[0])}function SendPaymentToServer(e,t=null,a=!0){var r=jQuery("#frmOrderData");jQuery("#checkout_nonce").val(paBraintree.checkout_nonce),null!=e?jQuery("#payment_nonce").val(e):null!=t&&jQuery("#payment_token").val(t),jQuery("#chb_card_save").is(":checked")?jQuery("#save_card").val("1"):jQuery("#save_card").val("0"),a?jQuery("#use_3ds").val("yes"):jQuery("#use_3ds").val("no"),null!=autorizeOnly&&jQuery("form.addtocart input[name='formats']").length&&(jQuery("#frmOrderData input[name='formats']").val(jQuery("form.addtocart input[name='formats']").val()),jQuery("#frmOrderData input[name='format_price_options']").val(jQuery("form.addtocart input[name='format_price_options']").val())),gtag("event","page_view",{page_path:"/user-payment/"}),jQuery.ajax({type:r.attr("method"),url:paBraintree.ajaxurl,data:r.serialize(),dataType:"json",success:function(e){if(null==e)return jQuery(".message").hasClass("error")||jQuery(".message").addClass("error"),jQuery(".message").html(paBraintree.txt_error_responce_result),void EnablePayForm();"0"==e.retcode?(paypalButton=document.querySelector("#paypal_pay_btn"),jQuery(".message").hasClass("error")||jQuery(".message").addClass("error"),jQuery(".message").html(e.message),EnablePayForm()):null!=e.redirect?location.href=e.redirect:null!=e.message&&(jQuery("#offer_price #frmOrderData").hide(100),jQuery("#offer_price #frmBrainTree").hide(100),jQuery("#offer_price .braintree_logo_box").hide(100),setTimeout(function(){jQuery("#offer_price #amount").val(""),jQuery(".message").html(""),jQuery("#offer_price #frmOrderData").show(100),jQuery("#offer_price #frmBrainTree").show(100),jQuery("#offer_price .braintree_logo_box").show(100)},5e3),paypalButton=document.querySelector("#paypal_pay_btn"),jQuery(".message").removeClass("error"),jQuery(".message").html(e.message),EnablePayForm())}})}function Run3DSequre(e,r="card"){components.threeDSecure.verifyCard({onLookupComplete:function(e,t){t()},amount:amountInput.value,nonce:e.nonce,bin:e.details.bin,email:emailInput.value,addFrame:addFrame,removeFrame:removeFrame},function(e,t){if(e){if(jQuery(".message").html(),0===e.code.indexOf("THREEDS_LOOKUP_VALIDATION"))jQuery(".message").html(paBraintree.txt_check_your_card_details);else if("THREEDS_LOOKUP_TOKENIZED_CARD_NOT_FOUND_ERROR"!==e.code)switch(e.code){case"THREEDS_CARDINAL_SDK_ERROR":jQuery(".message").html("An error occurred while attempting to authenticate.<br>Try a different payment method.");break;case"THREEDS_MISSING_VERIFY_CARD_OPTION":jQuery(".message").html("Price must be greater than zero.");break;default:jQuery(".message").html("Verification card failed.")}EnablePayForm()}else{e=!0;if(!t.liabilityShiftPossible||t.liabilityShifted){if(t.liabilityShiftPossible||t.liabilityShifted)!t.liabilityShiftPossible&&t.liabilityShifted&&(a=!0,jQuery(".message").html(),"authentication_bypassed"===t.threeDSecureInfo.status&&(a=!1),a||(e=!1));else{var a=!0;switch(jQuery(".message").html(),t.threeDSecureInfo.status){case"authentication_unavailable":case"authenticate_frictionless_failed":case"lookup_bypassed":case"lookup_error":case"lookup_not_enrolled":case"unsupported_card":case"data_only_successful":a=!1}a||(e=!1)}"card"!=r&&jQuery("#chb_card_save").prop("checked",!1),e?SendPaymentToServer(t.nonce,null,!0):components.hostedFields.tokenize(function(e,t){SendPaymentToServer(t.nonce,null,!1)}),"card"==r?gtag("event","paybutton",{event_category:"checkout",event_label:"card"}):"gpay"==r&&gtag("event","paybutton",{event_category:"checkout",event_label:"gpay"})}else{switch(jQuery(".message").html(),t.threeDSecureInfo.status){case"authenticate_failed":jQuery(".message").html("Cardholder enrolled, authentication unsuccessful.<br>Try attempt the transaction again.");break;case"authenticate_error":jQuery(".message").html("An error occurred within the 3D Secure authentication system.<br>Try attempt the transaction again.");break;case"authenticate_signature_verification_failed":jQuery(".message").html("An error occurred during the lookup.<br>Try attempt the transaction again.");break;case"authenticate_unable_to_authenticate":jQuery(".message").html("3D Secure authentication to fail.<br>Try attempt the transaction again.");break;case"lookup_enrolled":break;case"authenticate_rejected":jQuery(".message").html("Authentication unsuccessful.<br>Try a different payment method.");break;case"challenge_required":jQuery(".message").html("Cardholder enrolled, authentication unsuccessful.<br>Try a different payment method.");break;default:jQuery(".message").html("Verification card failed.")}EnablePayForm()}}})}function start(){null!=frmBrainTree?(xhr.onreadystatechange=function(){var e;4!==xhr.readyState||201!==xhr.status&&200!==xhr.status||(e=JSON.parse(xhr.responseText),merchantID=e.merchid,onFetchClientToken(e.token))},xhr.open("GET",paBraintree.ajaxurl+"?action=token_braintree&nonce="+paBraintree.bt_token_nonce,!0),xhr.send(),closeFrame.addEventListener("click",function(){components.threeDSecure.cancelVerifyCard(removeFrame()),EnablePayForm()})):(xhr.onreadystatechange=function(){var e;4!==xhr.readyState||201!==xhr.status&&200!==xhr.status||(e=JSON.parse(xhr.responseText),merchantID=e.merchid,onFetchClientToken(e.token))},xhr.open("GET",paBraintree.ajaxurl+"?action=token_braintree&nonce="+paBraintree.bt_token_nonce,!0),xhr.send())}function get_payment_nonce(e){xhr.onreadystatechange=function(){4!==xhr.readyState||201!==xhr.status&&200!==xhr.status||onFetchPaymentMethodNonce(JSON.parse(xhr.responseText),e)},xhr.open("GET",paBraintree.ajaxurl+"?action=paymethod_nonce_braintree&token="+e+"&nonce="+paBraintree.bt_token_nonce,!0),xhr.send()}function onFetchPaymentMethodNonce(e,t){1==e.retcode?Run3DSequre(e.payload):SendPaymentToServer(null,t)}function get_subscription_payment_nonce(e){xhr.onreadystatechange=function(){4!==xhr.readyState||201!==xhr.status&&200!==xhr.status||onFetchSubscriptionPaymentMethodNonce(JSON.parse(xhr.responseText))};var t=document.querySelector("#frmOrderData");const a=new FormData(t);a.set("action","paymethod_nonce_braintree_subscription"),a.set("paynonce",e),a.set("nonce",paBraintree.bt_token_nonce),xhr.open("POST",paBraintree.ajaxurl),xhr.send(a)}function onFetchSubscriptionPaymentMethodNonce(e){1==e.retcode?Run3DSequre(e.payload):(jQuery(".message").html(e.message),EnablePayForm())}function onFetchClientToken(t){require(require_modules,function(e,r,n,o,s){e.create({authorization:t},function(e,t){var a;e||(components.client=t,r.create({client:t,id:"frmBrainTree",styles:{input:{"font-family":"Trebuchet MS","font-size":"14px",color:"#000",background:"none",border:"0"},":focus":{color:"#000"}},fields:{number:{selector:"#card_number"},cvv:{selector:"#card_security",maskInput:!0,type:"password"},expirationDate:{selector:"#card_expiry_date",placeholder:"MM/YY"}}},onComponent("hostedFields")),!is_subscription&&window.ApplePaySession&&ApplePaySession.supportsVersion(3)&&ApplePaySession.canMakePayments()?s.create({client:t},function(e,r){e||ApplePaySession.canMakePaymentsWithActiveCard(r.merchantIdentifier).then(function(e){e&&(payBtnGroup.style.display="block",appleButton.style.display="block",allowApplePay=!0,appleButton.addEventListener("click",function(e){var t,a;"function"==typeof validateFields&&!validateFields()||(t=r.createPaymentRequest({total:{label:"Hum3D",amount:amountInput.value}}),(a=new ApplePaySession(3,t)).onvalidatemerchant=function(e){r.performValidation({validationURL:e.validationURL,displayName:"Hum3D"},function(e,t){e?jQuery(".message").html(paBraintree.txt_apple_pay_failed_load):a.completeMerchantValidation(t)})},a.onpaymentauthorized=function(e){r.tokenize({token:e.payment.token},function(e,t){return e?(a.completePayment(ApplePaySession.STATUS_FAILURE),void jQuery(".message").html(paBraintree.txt_apple_pay_error)):(payBtn.value=paBraintree.txt_processing,DisablePayForm(),jQuery("#chb_card_save").prop("checked",!1),SendPaymentToServer(t.nonce),gtag("event","paybutton",{event_category:"checkout",event_label:"applepay"}),void a.completePayment(ApplePaySession.STATUS_SUCCESS))})},a.begin())}))})}):is_subscription||null==paBraintree.allow_google||1!=paBraintree.allow_google||"undefined"!=typeof google&&(a=new google.payments.api.PaymentsClient({environment:paBraintree.environment}),o.create({client:t,googlePayVersion:2,googleMerchantId:"15929358870262152731"},function(e,t){e||a.isReadyToPay({apiVersion:2,apiVersionMinor:0,allowedPaymentMethods:t.createPaymentDataRequest().allowedPaymentMethods,existingPaymentMethodRequired:!0}).then(function(e){e.result&&(payBtnGroup.style.display="block",gbutton.style.display="block",allowGooglePay=!0,gbutton.addEventListener("click",function(e){e.preventDefault(),"function"==typeof validateFields&&!validateFields()||((e=t.createPaymentDataRequest({transactionInfo:{currencyCode:paBraintree.currency,totalPriceStatus:"FINAL",totalPrice:amountInput.value}})).allowedPaymentMethods[0],a.loadPaymentData(e).then(function(e){t.parseResponse(e,function(e,t){return e?(jQuery(".message").html(paBraintree.txt_google_payment_error),void EnablePayForm()):(payBtn.value=paBraintree.txt_processing,DisablePayForm(),void(components.threeDSecure&&!1===t.details.isNetworkTokenized?Run3DSequre(t,"gpay"):(jQuery("#chb_card_save").prop("checked",!1),SendPaymentToServer(t.nonce),gtag("event","paybutton",{event_category:"checkout",event_label:"gpay"}))))})}).catch(function(e){"CANCELED"!=e.statusCode&&jQuery(".message").html(paBraintree.txt_google_payment_error),EnablePayForm()}))}))}).catch(function(e){jQuery(".message").html(paBraintree.txt_google_payment_error),EnablePayForm()})})),null!=frmBrainTree&&n.create({version:2,client:t},onComponent("threeDSecure")))})})}function onComponent(a){return function(e,t){e||(components[a]=t,components.hostedFields&&(components.hostedFields.on("empty",function(e){$("#card-image").removeClass()}),components.hostedFields.on("cardTypeChange",function(e){1===e.cards.length?($("#card-image").removeClass().addClass(e.cards[0].type),4===e.cards[0].code.size&&components.hostedFields.setPlaceholder("cvv","1234")):components.hostedFields.setPlaceholder("cvv","123")}),components.hostedFields.on("validityChange",function(e){var t=e.fields[e.emittedBy];"number"==e.emittedBy&&t.isValid&&components.hostedFields.focus("expirationDate"),"expirationDate"==e.emittedBy&&t.isValid&&components.hostedFields.focus("cvv")}),setupForm()))}}function setupForm(){EnablePayForm()}function addFrame(e,t){bankFrame.appendChild(t),t.style.height="100%",t.style.width="100%",t.style.marginLeft="auto",t.style.marginRight="auto",btModal.classList.remove("hidden")}function removeFrame(){var e=bankFrame.querySelector("iframe");btModal.classList.add("hidden"),e.parentNode.removeChild(e)}function EnablePayForm(){null!=autorizeOnly?payBtn.value=paBraintree.txt_send_offer:(payBtn.value=paBraintree.txt_process_payment,payBtnSaved&&(payBtnSaved.removeAttribute("disabled"),payBtnSaved.value=paBraintree.txt_process_payment)),payBtn.removeAttribute("disabled"),allowGooglePay&&gbutton.removeAttribute("disabled"),allowApplePay&&appleButton.removeAttribute("disabled"),jQuery("#overlay_prod").length&&jQuery("#overlay_prod").hide()}function DisablePayForm(){payBtn.setAttribute("disabled","disabled"),allowGooglePay&&gbutton.setAttribute("disabled","disabled"),allowApplePay&&appleButton.setAttribute("disabled","disabled"),payBtnSaved&&payBtnSaved.setAttribute("disabled","disabled")}require_modules=null!=paBraintree.allow_google&&1==paBraintree.allow_google?(require.config({paths:{braintreeClient:"https://js.braintreegateway.com/web/3.56.0/js/client.min",hostedFields:"https://js.braintreegateway.com/web/3.56.0/js/hosted-fields",three_d_secure:"https://js.braintreegateway.com/web/3.56.0/js/three-d-secure.min",googlePayment:"https://js.braintreegateway.com/web/3.56.0/js/google-payment.min",applePay:"https://js.braintreegateway.com/web/3.56.0/js/apple-pay.min"}}),["braintreeClient","hostedFields","three_d_secure","googlePayment","applePay"]):(require.config({paths:{braintreeClient:"https://js.braintreegateway.com/web/3.56.0/js/client.min",hostedFields:"https://js.braintreegateway.com/web/3.56.0/js/hosted-fields",three_d_secure:"https://js.braintreegateway.com/web/3.56.0/js/three-d-secure.min",applePay:"https://js.braintreegateway.com/web/3.56.0/js/apple-pay.min"}}),["braintreeClient","hostedFields","three_d_secure","applePay"]),jQuery("#paysubmit").on("click",function(){var t;"function"==typeof validateFields&&!validateFields()||(t=components.hostedFields.getState(),Object.keys(t.fields).every(function(e){return t.fields[e].isValid})?(jQuery(".message").html(""),payBtn.value=paBraintree.txt_processing,DisablePayForm(),components.hostedFields.tokenize({authenticationInsight:{merchantAccountId:merchantID}},function(e,t){if(e){switch(e.code){case"HOSTED_FIELDS_FIELDS_EMPTY":jQuery(".message").html("All fields are empty! Please fill out the form.");break;case"HOSTED_FIELDS_FIELDS_INVALID":jQuery(".message").html("Some fields are invalid.");break;case"HOSTED_FIELDS_TOKENIZATION_FAIL_ON_DUPLICATE":jQuery(".message").html("This payment method already exists in your vault.");break;case"HOSTED_FIELDS_TOKENIZATION_CVV_VERIFICATION_FAILED":jQuery(".message").html("CVV did not pass verification");break;case"HOSTED_FIELDS_FAILED_TOKENIZATION":jQuery(".message").html("Tokenization failed server side. Is the card valid?");break;case"HOSTED_FIELDS_TOKENIZATION_NETWORK_ERROR":jQuery(".message").html("Network error occurred when tokenizing.");break;default:jQuery(".message").html("Something bad happened!")}EnablePayForm()}else{t.authenticationInsight.regulationEnvironment;is_subscription?get_subscription_payment_nonce(t.nonce):components.threeDSecure?Run3DSequre(t):(SendPaymentToServer(t.nonce),gtag("event","paybutton",{event_category:"checkout",event_label:"card"}))}})):jQuery(".message").html(paBraintree.txt_check_your_card_details))}),jQuery(document).on("click","#paypal_pay_btn",function(e){jQuery("#pay-paypal").click()}),jQuery(document).on("click","#choose_btn",function(e){jQuery("#cardList").toggle(),jQuery("#cardNew").toggle()}),jQuery(document).on("click","div#cardList span.saved_card button",function(e){editMode?(jQuery("#cardList").hide(),jQuery("#cardNew").hide(),jQuery("#delete_ctype").html(jQuery(this).data("ctype")),jQuery("#delete_last4").html(jQuery(this).data("last4")),deleteToken=jQuery(this).data("token"),jQuery("#cardRemove").show()):(jQuery("div#cardList button.active").removeClass("active"),jQuery(this).addClass("active"))}),jQuery(document).on("click","button#remove_card_cancel",function(e){jQuery("#cardRemove").hide(),jQuery("#cardList").show()}),jQuery(document).on("click","button#remove_card_delete",function(e){jQuery.ajax({type:"POST",url:paBraintree.ajaxurl,data:{action:"delete_payment_method",token:deleteToken,nonce:paBraintree.checkout_nonce},dataType:"json",success:function(e){return null==e?(jQuery(".message").hasClass("error")||jQuery(".message").addClass("error"),jQuery(".message").html(paBraintree.txt_error_responce_result),void EnablePayForm()):"0"==e.retcode?(jQuery(".message").hasClass("error")||jQuery(".message").addClass("error"),jQuery(".message").html(e.message),void EnablePayForm()):(null!=e.token&&jQuery("div#cardList button").each(function(){if(jQuery(this).data("token")==e.token)return jQuery(this).closest("span.saved_card").remove(),!1}),EnablePayForm(),jQuery("#cardRemove").hide(),void(jQuery("div#cardList span.saved_card button").length?(jQuery("#cardList").show(),jQuery(payBtnSaved).show()):(jQuery("#cardList").hide(),jQuery("#cardNew").show(),jQuery("#choose_btn").hide())))}})}),jQuery("#paysubmit_saved").on("click",function(){var e=jQuery("div#cardList button.active");e.length?(e=e.data("token")).length?(jQuery("#chb_card_save").prop("checked",!1),payBtnSaved.value=paBraintree.txt_processing,DisablePayForm(),get_payment_nonce(e)):jQuery(".message").html(paBraintree.txt_tokenization_failed):jQuery(".message").html(paBraintree.txt_select_payment_method)}),null!=editPaymentMethodBtn&&editPaymentMethodBtn.addEventListener("click",function(e){(editMode=!editMode)?(DisablePayForm(),jQuery(payBtnSaved).hide(),jQuery(editPaymentMethodBtn).html(paBraintree.txt_cancel),jQuery("div#cardList span.saved_card button").addClass("remove_card")):(EnablePayForm(),jQuery(editPaymentMethodBtn).html(paBraintree.txt_edit),jQuery("div#cardList span.saved_card button").removeClass("remove_card"),jQuery(payBtnSaved).show())}),start();